sudo: required
language : 
  - go  

services:
  - docker
os:
  - linux
  - osx
  - windows

branches:
  only:
    - master
    - testing-buildscript
    - /^v\d+\.\d+\.\d+(\.\d+)?(-\S*)?$/
    
cache:
  bundler: false
  directories:
  - .build-cache          # images.txt
# Handle git submodules yourself
git:
    submodules: false
# Do a github login using token
before_install:
  - "echo -e \"machine github.com\n  login ${GITHUB_USER_TOKEN}\" >> ~/.netrc"
install:
  - go get -u github.com/constabulary/gb/...
  - cd $GOPATH/src/github.com/TIBCOSoftware
  - git clone https://github.com/TIBCOSoftware/mashling-recipes.git mashling-recipes
  - git clone https://github.com/TIBCOSoftware/mashling-cicd.git mashling-cicd ;
  - cd $GOPATH/src/github.com/TIBCOSoftware/mashling
  - go get ./...
  - go install ./...
  - mashling help
  
  
script:
  - cd $GOPATH/src/github.com/TIBCOSoftware
  - pushd mashling-cicd/sample-recipes
  - rm -rf builds
  - mkdir -p builds/latest master-builds/latest
  - chmod ugo+x ./build-recipes.sh ./sanity.sh ./build-registry-recipes.sh
  - ./build-recipes.sh
  - ./sanity.sh
  - popd
  - pushd mashling-cicd/sample-recipes
  - ./build-registry-recipes.sh
  - popd
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then    
    pushd mashling-cicd/docker/mashling;
    chmod ugo+x ./build-mashling.sh ;
    ./build-mashling.sh ;
    popd ;
    fi
  #- if [ "$TRAVIS_OS_NAME" == "linux" ]; then      
   # pushd mashling-cicd/docker/mashling-sample;
   # chmod ugo+x ./build-mashling-sample.sh ;
   # ./build-mashling-sample.sh ;
   # popd ;
   # fi
    
after_script:
  - "[ -f \"${HOME}/.netrc\" ] && rm -f ${HOME}/.netrc"

after_success:
  - "docker login -u=\"${DOCKER_USERNAME}\" -p=\"${DOCKER_PASSWORD}\" tibdocker.tibco.com"
  - "if [ \"${TRAVIS_BRANCH}\" == \"master\" ]; then
    source $GOPATH/src/github.com/TIBCOSoftware/mashling-cicd/scripts/init.sh ;
    mashling::module::postbuild mashling mashling ;
    fi"
  # - "if [ \"${TRAVIS_BRANCH}\" == \"master\" ]; then
    # source  $GOPATH/src/github.com/TIBCOSoftware/mashling-cicd/scripts/init.sh;
    # mashling::module::postbuild mashling-sample mashling-sample ;
    # fi"  
    
deploy:  
  provider: s3
  access_key_id: $SITE_KEY
  secret_access_key: $SITE_KEY_SECRET
  bucket: $AWS_BUCKET
  region: $AWS_REGION
  skip_cleanup: true
  on:
    all_branches: true
  local_dir: $GOPATH/src/github.com/TIBCOSoftware/mashling-cicd/sample-recipes/master-builds
  upload-dir: master-builds

notifications: 
  email: 
    on_failure: always
    on_success: always
    recipients: 
      - jpark@tibco.com
      - rpolishe@tibco.com
      - lmekala@tibco.com
      - nthota@tibco.com
      - ykalidin@tibco.com
